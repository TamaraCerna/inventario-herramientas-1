pipeline {
    agent any

    // Usamos nuestro propio stage de Checkout
    options {
        skipDefaultCheckout(true)
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build & Test (Maven)') {
            steps {
                dir('Backend') {
                    sh '''
                        chmod +x mvnw
                        # Si quieres correr tests: ./mvnw clean test
                        # Como los est치s saltando:
                        ./mvnw clean package
                    '''
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                sh '''
                    # Si no existe el comando docker, salimos "en verde"
                    if ! command -v docker >/dev/null 2>&1; then
                      echo ">> Docker NO est치 disponible dentro de Jenkins. Se omite el build de la imagen."
                      exit 0
                    fi

                    echo ">> Docker encontrado, construyendo imagen..."
                    docker build \
                      -t tm4ra/toolrent-backend:build-${BUILD_NUMBER} \
                      -f Backend/dockerfile \
                      Backend
                '''
            }
        }

        stage('Login & Push to Docker Hub') {
            // Solo intentamos si existen las variables de entorno
            when {
                expression { return env.DOCKER_HUB_USER && env.DOCKER_HUB_TOKEN }
            }
            steps {
                sh '''
                    if ! command -v docker >/dev/null 2>&1; then
                      echo ">> Docker NO est치 disponible dentro de Jenkins. Se omite el push a Docker Hub."
                      exit 0
                    fi

                    echo ">> Docker encontrado, logueando y subiendo imagen..."
                    echo "${DOCKER_HUB_TOKEN}" | docker login -u "${DOCKER_HUB_USER}" --password-stdin
                    docker push tm4ra/toolrent-backend:build-${BUILD_NUMBER}
                '''
            }
        }
    }

    post {
        always {
            sh '''
                if command -v docker >/dev/null 2>&1; then
                  echo ">> Limpiando recursos de Docker..."
                  docker system prune -f || true
                else
                  echo ">> Docker no est치 disponible, se omite docker system prune."
                fi
            '''
        }
    }
}

